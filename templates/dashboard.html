<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SoftCare AI ‚Äî Chat</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    body {
      height: 100vh;
      height: 100dvh;
      background: radial-gradient(circle at top, #312e81, #020617 65%);
      color: #fff;
      overflow: hidden;
    }

    /* üå´Ô∏è BACKGROUND BLUR BLOBS */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 20% 20%, rgba(124, 77, 255, .35), transparent 40%),
        radial-gradient(circle at 80% 80%, rgba(56, 189, 248, .30), transparent 45%);
      filter: blur(120px);
      z-index: -2;
    }

    /* NOISE */
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><filter id='n'><feTurbulence baseFrequency='0.9'/></filter></svg>");
      opacity: 0.035;
      pointer-events: none;
      z-index: -1;
    }

    /* GLOSS */
    .gloss {
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: linear-gradient(120deg, rgba(255, 255, 255, .06), transparent 60%);
    }

    /* OVERLAY */
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .45);
      opacity: 0;
      pointer-events: none;
      transition: .3s;
      z-index: 5;
    }

    #overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    /* APP */
    .app {
      display: flex;
      height: 100%;
    }

    /* SIDEBAR */
    #sidebar {
      width: 260px;
      padding: 20px;
      background: rgba(15, 23, 42, .65);
      backdrop-filter: blur(22px);
      border-right: 1px solid rgba(255, 255, 255, .08);
      box-shadow: 0 0 40px rgba(124, 77, 255, .25);
      transition: .3s;
      z-index: 50;
    }

    .sidebar-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 22px;
    }

    .close-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 22px;
      cursor: pointer;
      display: none;
    }

    .side-item {
      padding: 14px;
      border-radius: 14px;
      cursor: pointer;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .side-item:hover {
      background: rgba(255, 255, 255, .10);
      box-shadow: 0 0 18px rgba(124, 77, 255, .25);
    }

    /* MAIN */
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* TOPBAR */
    .topbar {
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 255, 255, .06);
      backdrop-filter: blur(18px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, .35);
    }

    .top-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    #menuBtn {
      cursor: pointer;
    }

    /* PROFILE */
    .profile {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, #7c4dff, #a78bfa);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      cursor: pointer;
      overflow: hidden;
      box-shadow: 0 0 18px rgba(124, 77, 255, .6);
    }

    .profile img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }


    /* CHAT */
    .chat-area {
      flex: 1;
      padding: 26px;
      padding-bottom: 110px;
      /* üî• input ke liye space */

      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
    }


    /* MESSAGE */
    .msg {
      max-width: 68%;
      width: fit-content;
      padding: 14px 20px;
      border-radius: 20px;
      line-height: 1.55;
      font-size: 15px;
      backdrop-filter: blur(12px);
    }

    /* AI bubble */
    .msg.ai {
      background: linear-gradient(135deg,
          rgba(255, 255, 255, 0.18),
          rgba(255, 255, 255, 0.05));
      border: 1px solid rgba(255, 255, 255, 0.14);
      border-bottom-left-radius: 6px;
      box-shadow:
        0 10px 35px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    /* USER bubble */
    .msg.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #7c4dff, #a78bfa);
      border-bottom-right-radius: 6px;
      box-shadow: 0 10px 30px rgba(124, 77, 255, .45);
    }

    /* INPUT */
    .chat-input {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;

      display: flex;
      gap: 12px;
      padding: 14px;

      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(20px);
      box-shadow: 0 -10px 30px rgba(0, 0, 0, .35);

      z-index: 20;
    }


    .chat-input textarea {
      flex: 1;
      resize: none;
      padding: 14px;
      border-radius: 14px;
      border: none;
      outline: none;
      background: rgba(0, 0, 0, .4);
      color: #fff;
    }

    .chat-input button {
      width: 48px;
      border-radius: 14px;
      border: none;
      background: #7c4dff;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(124, 77, 255, .7);
    }

    /* DESKTOP SIDEBAR HIDE */
    .sidebar-hidden #sidebar {
      width: 0;
      padding: 0;
      overflow: hidden;
    }

    /* MOBILE */
    @media(max-width:1024px) {
      #sidebar {
        position: fixed;
        left: -100%;
        top: 0;
        height: 100%;
      }

      #sidebar.active {
        left: 0;
      }

      #sidebar.active .close-btn {
        display: block;
      }
    }

    /* TYPING CURSOR */
    .typing-cursor {
      display: inline-block;
      margin-left: 2px;
      animation: blink 1s steps(2, start) infinite;
    }

    @keyframes blink {
      to {
        visibility: hidden;
      }
    }

    #sidebar {
      display: flex;
      flex-direction: column;
      height: 100vh;
      height: 100dvh;
    }

    /* menu stays on top */
    .sidebar-menu {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    /* logout always at bottom */
    .sidebar-bottom {
      border-top: 1px solid rgba(255, 255, 255, .1);
      padding-top: 14px;
    }

    /* üî• RECENT LIST HIDDEN DEFAULT */
    .recent-list {
      display: none;
      margin-top: 10px;
      padding-left: 10px;
      /* Indent slightly */
    }

    .side-item.logout {
      display: flex;
      justify-content: space-between;
    }


    /* ===== RECENT CHAT ITEM (FINAL FIX) ===== */
    .recent-item {
      position: relative;
      display: flex;
      align-items: center;

      padding: 10px 14px;
      margin-bottom: 8px;

      border-radius: 16px;
      background: rgba(255, 255, 255, .10);
      cursor: pointer;

      /* üî• IMPORTANT */
      overflow: visible;
    }

    /* Hover effect */
    .recent-item:hover {
      background: rgba(124, 77, 255, .35);
    }

    /* TITLE */
    .recent-title {
      flex: 1;
      font-size: 14px;

      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;

      /* üî• reserve space for dots */
      margin-right: 28px;
    }

    /* ===== 3 DOT ===== */
    .recent-actions {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);

      width: 24px;
      height: 24px;

      display: flex;
      align-items: center;
      justify-content: center;

      font-size: 18px;
      border-radius: 8px;
      cursor: pointer;

      opacity: 0;
      transition: opacity .2s ease, background .2s ease;

      z-index: 5;
    }

    /* show dots */
    .recent-item:hover .recent-actions {
      opacity: 1;
    }

    .recent-actions:hover {
      background: rgba(255, 255, 255, .2);
    }

    /* ===== DROPDOWN ===== */
    .recent-menu {
      position: absolute;
      right: 10px;
      top: 42px;

      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);

      border-radius: 14px;
      padding: 6px;

      display: none;
      z-index: 999;
      min-width: 150px;
      animation: menuFade 0.2s ease-out;
    }

    @keyframes menuFade {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .recent-menu div {
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 14px;
      color: #cbd5e1;
      cursor: pointer;
      transition: 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .recent-menu div:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .recent-menu div.danger:hover {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
    }

    /* RENAME INPUT & TEXTAREA */
    .modal-input,
    .modal-textarea {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 12px;
      color: #fff;
      font-size: 0.95rem;
      margin-bottom: 24px;
      outline: none;
      font-family: inherit;
    }

    .modal-input:focus,
    .modal-textarea:focus {
      border-color: #7c4dff;
    }

    .modal-textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.5;
    }

    /* TYPING INDICATOR */
    .typing-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 12px 16px;
      /* Same padding as messages */
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    /* TOAST NOTIFICATION */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 12px 24px;
      border-radius: 99px;
      color: #fff;
      font-size: 0.95rem;
      font-weight: 500;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      z-index: 2000;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      pointer-events: none;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toast.active {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast-icon {
      font-size: 1.1rem;
    }

    .typing-dot:nth-child(1) {
      animation-delay: -0.32s;
    }

    .typing-dot:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes bounce {

      0%,
      80%,
      100% {
        transform: scale(0);
      }

      40% {
        transform: scale(1);
      }
    }

    /* MODAL */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: 0.3s;
      z-index: 1000;
    }

    .modal-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-box {
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 24px;
      max-width: 340px;
      width: 90%;
      text-align: center;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      transform: scale(0.9);
      transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .modal-overlay.active .modal-box {
      transform: scale(1);
    }

    .modal-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .modal-desc {
      font-size: 0.9rem;
      color: #94a3b8;
      margin-bottom: 24px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
    }

    .modal-btn {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: 0.2s;
    }

    .btn-cancel {
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
    }

    .btn-cancel:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .btn-danger {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.3);
      color: #fff;
    }
  </style>
</head>

<body>

  <div class="gloss"></div>
  <div id="overlay"></div>

  <!-- DELETE MODAL -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal-box">
      <div class="modal-title">Delete Chat?</div>
      <div class="modal-desc">This action cannot be undone. Are you sure?</div>
      <div class="modal-actions">
        <button class="modal-btn btn-cancel" onclick="closeModal()">Cancel</button>
        <button class="modal-btn btn-danger" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <!-- RENAME MODAL -->
  <div class="modal-overlay" id="renameModal">
    <div class="modal-box">
      <div class="modal-title">Rename Chat</div>
      <div class="modal-desc">Enter a new name for this conversation.</div>
      <input type="text" class="modal-input" id="renameInput" placeholder="Chat name..."
        onkeydown="if(event.key==='Enter') confirmRename()">
      <div class="modal-actions">
        <button class="modal-btn btn-cancel" onclick="closeRenameModal()">Cancel</button>
        <button class="modal-btn btn-save" style="background:var(--primary); color:#fff"
          onclick="confirmRename()">Save</button>
      </div>
    </div>
  </div>

  <!-- SHARE MODAL -->
  <div class="modal-overlay" id="shareModal">
    <div class="modal-box">
      <div class="modal-title">Share Conversation</div>
      <div class="modal-desc">Copy this text to share with others.</div>
      <textarea class="modal-textarea" id="shareText" readonly></textarea>
      <div class="modal-actions">
        <button class="modal-btn btn-cancel" onclick="closeShareModal()">Close</button>
        <button class="modal-btn btn-save" id="copyShareBtn" style="background:#22c55e; color:#fff"
          onclick="copyShareContent()">Copy Text</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast">
    <span class="toast-icon">‚úÖ</span>
    <span id="toastMsg">Action Successful</span>
  </div>

  <div class="app" id="app">

    <!-- SIDEBAR -->
    <aside id="sidebar">
      <div class="sidebar-top">
        <h2>SoftCare AI</h2>
        <button class="close-btn" id="closeBtn">
          <i class="fa fa-xmark"></i>
        </button>
      </div>

      <!-- MAIN MENU -->
      <div class="sidebar-menu">
        <div class="side-item" onclick="goProfile()">üë§ Profile</div>
        <div class="side-item" onclick="newChat()">‚ûï New Chat</div>
        <div class="side-item" onclick="toggleRecent()">üìú Recent</div>

        <div class="recent-list" id="recentList"></div>

      </div>

      <!-- LOGOUT (BOTTOM FIXED) -->
      <div class="sidebar-bottom">
        <div class="side-item logout" onclick="location.href='/logout'">
          <span>üö™ Logout</span>
          <i class="fa fa-sign-out-alt"></i>
        </div>
      </div>
    </aside>


    <!-- MAIN -->
    <main>
      <div class="topbar">
        <div class="top-left">
          <i class="fa fa-bars" id="menuBtn"></i>
          <b>SoftCare AI</b>
        </div>
        <div class="profile" id="topAvatar" onclick="goProfile()">
          {% if user.avatar %}
          <img src="{{ user.avatar }}" alt="Profile">
          {% else %}
          {{ user.name[0]|upper }}
          {% endif %}
        </div>


      </div>

      <div class="chat-area" id="chat">
        <div class="msg ai">
          Hello üëã<br>
          I‚Äôm <b>SoftCare AI</b>. How can I help you today?
        </div>
      </div>

      <div class="chat-input">
        <textarea id="input" rows="1" placeholder="Type your message..."></textarea>
        <button id="sendBtn"><i class="fa fa-paper-plane"></i></button>
      </div>
    </main>
  </div>
  <script>
    /* ================= SIDEBAR ================= */
    const app = document.getElementById("app");
    const sidebar = document.getElementById("sidebar");
    const menuBtn = document.getElementById("menuBtn");
    const closeBtn = document.getElementById("closeBtn");
    const overlay = document.getElementById("overlay");

    menuBtn.onclick = () => {
      if (window.innerWidth > 1024) {
        app.classList.toggle("sidebar-hidden");
      } else {
        sidebar.classList.add("active");
        overlay.classList.add("active");
      }
    };

    function closeSidebar() {
      sidebar.classList.remove("active");
      overlay.classList.remove("active");
    }

    closeBtn.onclick = closeSidebar;
    overlay.onclick = closeSidebar;

    function goProfile() {
      location.href = "/profile";
    }

    /* ================= CHAT ================= */
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const chat = document.getElementById("chat");

    /* ================= RECENT ================= */
    const recentList = document.getElementById("recentList");
    const userEmail = "{{ user.email }}"; // Injected by Flask
    const storageKey = `softcare_recent_${userEmail}`;

    let recentChats = JSON.parse(localStorage.getItem(storageKey)) || [];

    let currentChat = [];
    let chatStarted = false;
    let activeRecentIndex = null; // üî• NEW

    /* Toggle recent */
    function toggleRecent() {
      recentList.style.display =
        recentList.style.display === "block" ? "none" : "block";
    }

    /* Render recent list */
    function renderRecent() {
      recentList.innerHTML = "";

      recentChats.forEach((c, i) => {
        const item = document.createElement("div");
        item.className = "recent-item";

        const title = document.createElement("div");
        title.className = "recent-title";
        title.textContent = c.title;
        title.onclick = () => loadRecent(i);

        const dots = document.createElement("div");
        dots.className = "recent-actions";
        dots.textContent = "‚ãÆ";

        const menu = document.createElement("div");
        menu.className = "recent-menu";
        menu.innerHTML = `
      <div onclick="renameChat(${i})">‚úèÔ∏è Rename</div>
      <div onclick="shareChat(${i})">üîó Share</div>
      <div class="danger" onclick="deleteChat(${i})">üóëÔ∏è Delete</div>
    `;

        dots.onclick = (e) => {
          e.stopPropagation();
          document.querySelectorAll(".recent-menu")
            .forEach(m => m.style.display = "none");
          menu.style.display =
            menu.style.display === "block" ? "none" : "block";
        };

        item.append(title, dots, menu);
        recentList.appendChild(item);
      });
    }

    /* ================= LOAD RECENT ================= */
    function loadRecent(index) {
      const data = recentChats[index];
      if (!data) return;

      chat.innerHTML = "";
      currentChat = [...data.messages];
      chatStarted = true;
      activeRecentIndex = index; // üî• track active chat

      currentChat.forEach(m => {
        const div = document.createElement("div");
        div.className = "msg " + m.role;
        div.textContent = m.text;
        chat.appendChild(div);
      });

      closeSidebar();
    }

    /* ================= SEND MESSAGE ================= */
    async function sendMsg() {
      const text = input.value.trim();
      if (!text) return;

      chatStarted = true;

      // USER MSG
      const userMsg = document.createElement("div");
      userMsg.className = "msg user";
      userMsg.textContent = text;
      chat.appendChild(userMsg);

      currentChat.push({
        role: "user",
        text
      });
      input.value = "";
      chat.scrollTop = chat.scrollHeight;

      /* üî• AUTO SAVE / UPDATE RECENT */
      if (activeRecentIndex === null) {
        recentChats.unshift({
          title: text.slice(0, 30),
          messages: [...currentChat]
        });
        activeRecentIndex = 0;
      } else {
        recentChats[activeRecentIndex].messages = [...currentChat];
      }

      localStorage.setItem(storageKey, JSON.stringify(recentChats));
      renderRecent();

      // Show Typing Indicator
      const typingMsg = document.createElement("div");
      typingMsg.className = "msg ai typing-indicator";
      typingMsg.innerHTML = `
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      `;
      chat.appendChild(typingMsg);
      chat.scrollTop = chat.scrollHeight;

      // Simulate human thinking delay (1.5s to 2.5s)
      const delay = Math.random() * 1000 + 1500;
      await new Promise(r => setTimeout(r, delay));

      // Remove typing indicator
      typingMsg.remove();

      // AI MSG PLACEMENT
      const aiMsg = document.createElement("div");
      aiMsg.className = "msg ai";
      chat.appendChild(aiMsg);

      try {
        const res = await fetch("/stream", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: text
          })
        });

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let aiText = "";

        while (true) {
          const {
            value,
            done
          } = await reader.read();
          if (done) break;
          aiText += decoder.decode(value);
          aiMsg.textContent = aiText;
          chat.scrollTop = chat.scrollHeight;
        }

        currentChat.push({
          role: "ai",
          text: aiText
        });

        // üî• update same recent after AI reply
        recentChats[activeRecentIndex].messages = [...currentChat];
        localStorage.setItem(storageKey, JSON.stringify(recentChats));

      } catch {
        aiMsg.textContent = "üòì Connection glitch. Retrying usually helps!";
      }
    }

    /* ================= NEW CHAT ================= */
    function newChat() {
      currentChat = [];
      chatStarted = false;
      activeRecentIndex = null; // üî• reset

      chat.innerHTML = `
    <div class="msg ai">
      Hello üëã<br>
      I‚Äôm <b>SoftCare AI</b>. How can I help you today?
    </div>
  `;

      closeSidebar();
    }

    /* ================= EVENTS ================= */
    sendBtn.onclick = sendMsg;

    input.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMsg();
      }
    });

    /* ================= RECENT ACTIONS ================= */
    /* ================= DELETE MODAL LOGIC ================= */
    let chatToDeleteIndex = null;
    const deleteModal = document.getElementById("deleteModal");

    function deleteChat(index) {
      chatToDeleteIndex = index;
      deleteModal.classList.add("active");
    }

    function closeModal() {
      deleteModal.classList.remove("active");
      chatToDeleteIndex = null;
    }

    function confirmDelete() {
      if (chatToDeleteIndex === null) return;

      recentChats.splice(chatToDeleteIndex, 1);
      localStorage.setItem(storageKey, JSON.stringify(recentChats));
      renderRecent();

      // If we deleted the active chat, clear view
      if (activeRecentIndex === chatToDeleteIndex) {
        newChat();
      } else if (activeRecentIndex > chatToDeleteIndex) {
        activeRecentIndex--; // adjust index
      }

      closeModal();
    }

    /* ================= RENAME MODAL LOGIC ================= */
    let chatToRenameIndex = null;
    const renameModal = document.getElementById("renameModal");
    const renameInput = document.getElementById("renameInput");

    function renameChat(index) {
      chatToRenameIndex = index;
      renameInput.value = recentChats[index].title;
      renameModal.classList.add("active");
      setTimeout(() => renameInput.focus(), 100);
    }

    function closeRenameModal() {
      renameModal.classList.remove("active");
      chatToRenameIndex = null;
    }

    function confirmRename() {
      const newName = renameInput.value.trim();
      if (!newName || chatToRenameIndex === null) return;

      recentChats[chatToRenameIndex].title = newName.slice(0, 40);
      localStorage.setItem(storageKey, JSON.stringify(recentChats));
      renderRecent();

      closeRenameModal();
    }

    /* ================= SHARE MODAL LOGIC ================= */
    const shareModal = document.getElementById("shareModal");
    const shareText = document.getElementById("shareText");
    const copyShareBtn = document.getElementById("copyShareBtn");

    function shareChat(index) {
      const text = recentChats[index].messages
        .map(m => `${m.role.toUpperCase()}: ${m.text}`)
        .join("\n\n");

      shareText.value = text;
      shareModal.classList.add("active");
    }

    function closeShareModal() {
      shareModal.classList.remove("active");
      setTimeout(() => {
        copyShareBtn.textContent = "Copy Text";
        copyShareBtn.style.background = "#22c55e";
      }, 300);
    }

    /* ================= TOAST LOGIC ================= */
    const toast = document.getElementById("toast");
    const toastMsg = document.getElementById("toastMsg");

    function showToast(message) {
      toastMsg.textContent = message;
      toast.classList.add("active");
      setTimeout(() => {
        toast.classList.remove("active");
      }, 3000);
    }

    function copyShareContent() {
      shareText.select();
      shareText.setSelectionRange(0, 99999); // Mobile
      navigator.clipboard.writeText(shareText.value).then(() => {
        // Close modal immediately
        closeShareModal();
        // Show Toast
        showToast("Chat copied successfully! üìã");
      });
    }

    document.addEventListener("click", () => {
      document.querySelectorAll(".recent-menu")
        .forEach(m => m.style.display = "none");
    });

    /* INIT */
    renderRecent();
  </script>




</body>

</html>